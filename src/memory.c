
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "memory.h"

uint8_t boot_rom[] = {
  0x31, 0xFE, 0xFF, 0xAF, 0x21, 0xFF, 0x9F, 0x32, 0xCB, 0x7C, 0x20, 0xFB, 0x21, 0x26, 0xFF, 0x0E,
  0x11, 0x3E, 0x80, 0x32, 0xE2, 0x0C, 0x3E, 0xF3, 0xE2, 0x32, 0x3E, 0x77, 0x77, 0x3E, 0xFC, 0xE0,
  0x47, 0x11, 0x04, 0x01, 0x21, 0x10, 0x80, 0x1A, 0xCD, 0x95, 0x00, 0xCD, 0x96, 0x00, 0x13, 0x7B,
  0xFE, 0x34, 0x20, 0xF3, 0x11, 0xD8, 0x00, 0x06, 0x08, 0x1A, 0x13, 0x22, 0x23, 0x05, 0x20, 0xF9,
  0x3E, 0x19, 0xEA, 0x10, 0x99, 0x21, 0x2F, 0x99, 0x0E, 0x0C, 0x3D, 0x28, 0x08, 0x32, 0x0D, 0x20,
  0xF9, 0x2E, 0x0F, 0x18, 0xF3, 0x67, 0x3E, 0x64, 0x57, 0xE0, 0x42, 0x3E, 0x91, 0xE0, 0x40, 0x04,
  0x1E, 0x02, 0x0E, 0x0C, 0xF0, 0x44, 0xFE, 0x90, 0x20, 0xFA, 0x0D, 0x20, 0xF7, 0x1D, 0x20, 0xF2,
  0x0E, 0x13, 0x24, 0x7C, 0x1E, 0x83, 0xFE, 0x62, 0x28, 0x06, 0x1E, 0xC1, 0xFE, 0x64, 0x20, 0x06,
  0x7B, 0xE2, 0x0C, 0x3E, 0x87, 0xE2, 0xF0, 0x42, 0x90, 0xE0, 0x42, 0x15, 0x20, 0xD2, 0x05, 0x20,
  0x4F, 0x16, 0x20, 0x18, 0xCB, 0x4F, 0x06, 0x04, 0xC5, 0xCB, 0x11, 0x17, 0xC1, 0xCB, 0x11, 0x17,
  0x05, 0x20, 0xF5, 0x22, 0x23, 0x22, 0x23, 0xC9, 0xCE, 0xED, 0x66, 0x66, 0xCC, 0x0D, 0x00, 0x0B,
  0x03, 0x73, 0x00, 0x83, 0x00, 0x0C, 0x00, 0x0D, 0x00, 0x08, 0x11, 0x1F, 0x88, 0x89, 0x00, 0x0E,
  0xDC, 0xCC, 0x6E, 0xE6, 0xDD, 0xDD, 0xD9, 0x99, 0xBB, 0xBB, 0x67, 0x63, 0x6E, 0x0E, 0xEC, 0xCC,
  0xDD, 0xDC, 0x99, 0x9F, 0xBB, 0xB9, 0x33, 0x3E, 0x3C, 0x42, 0xB9, 0xA5, 0xB9, 0xA5, 0x42, 0x3C,
  0x21, 0x04, 0x01, 0x11, 0xA8, 0x00, 0x1A, 0x13, 0xBE, 0x00, 0x00, 0x23, 0x7D, 0xFE, 0x34, 0x20,
  0xF5, 0x06, 0x19, 0x78, 0x86, 0x23, 0x05, 0x20, 0xFB, 0x86, 0x00, 0x00, 0x3E, 0x01, 0xE0, 0x50
};

void memory_init(struct memory *mem, uint8_t *cartridge_data, memory_write_handler_t handler)
{
  memset(mem, 0, sizeof(struct memory));
  mem->ppu_mode = pmLCD_MODE_HBLANK;
  mem->cartridge_bank = 1;
  mem->cartridge_data = cartridge_data;
  mem->memory = calloc(0x10000, 1);
  mem->write_handler = handler;
}

uint8_t memory_read_ppu(struct memory *mem, uint16_t addr, uint8_t ppu)
{
  if (addr < 0x4000)
  {
    if (addr <= 0xFF && mem->memory[0xFF50] != 1)
      return boot_rom[addr];
    return mem->cartridge_data[addr];
  }

  if (addr < 0x8000)
    return mem->cartridge_data[addr + ((mem->cartridge_bank - 1) * 0x4000)];
  if (addr < 0xA000 && !ppu && mem->ppu_mode == pmLCD_MODE_TRANSFER) return 0xFF;
  if (
    addr >= 0xFE00 && addr < 0xFEA0 && !ppu
    && (mem->ppu_mode == pmLCD_MODE_TRANSFER || mem->ppu_mode == pmLCD_MODE_OAM)
    )
    return 0xFF;
  if (addr == 0xFF4D) return 0xFF;

  // TODO remove this when inputs are implemented
  if (addr == ADDR_REG_INPUT) return 0xFF;

  return mem->memory[addr];
}

uint8_t memory_read(struct memory *mem, uint16_t addr)
{
  return memory_read_ppu(mem, addr, 0);
}

void dma_transfer(struct memory *mem, uint8_t value)
{
  mem->memory[ADDR_REG_DMA] = value;
  uint16_t start_address = value << 8;
  for (uint32_t i = 0; i < 0xA0; ++i)
  {
    uint16_t src = start_address + i;
    uint16_t dest = 0xFE00 + i;
    mem->memory[dest] = memory_read_ppu(mem, src, 1);
  }
}

void memory_write(struct memory *mem, uint16_t addr, uint8_t value)
{
  if (addr == ADDR_REG_LCD_Y) mem->memory[addr] = 0;
  else if (addr == ADDR_REG_DIVIDER)
  {
    mem->memory[ADDR_REG_INTERNAL_CLOCK_LOW] = 0;
    mem->memory[addr] = 0;
  }
  else if (addr == ADDR_REG_DMA) dma_transfer(mem, value);
  else if (addr == ADDR_REG_INPUT)
    mem->memory[addr] = (value & 0x30) | (mem->memory[addr] & 0xCF);
  else if (addr == ADDR_REG_LCD_STATUS)
    mem->memory[addr] = (value & 0x7C) | (mem->memory[addr] & 3);
  else if (addr >= ADDR_ROM_BANK_SWITCH_START && addr < ADDR_ROM_BANK_SWITCH_END)
    mem->cartridge_bank = value;
  else mem->memory[addr] = value;

  if (mem->write_handler) mem->write_handler(addr, value);
}

void memory_set_and_write_ppu_mode(struct memory *mem, enum ppu_mode mode)
{
  mem->ppu_mode = mode;
  uint8_t value = (uint8_t)mode;
  if ((value >> 1) & 1)
    mem->memory[ADDR_REG_LCD_STATUS] |= FLAG_LCD_STATUS_MODE_HIGH;
  else
    mem->memory[ADDR_REG_LCD_STATUS] &= ~FLAG_LCD_STATUS_MODE_HIGH;
  if (value & 1)
    mem->memory[ADDR_REG_LCD_STATUS] |= FLAG_LCD_STATUS_MODE_LOW;
  else
    mem->memory[ADDR_REG_LCD_STATUS] &= ~FLAG_LCD_STATUS_MODE_LOW;
}
